@---------------------------------------------------------------------------------
.section .text,"ax"
@---------------------------------------------------------------------------------
	#include "equates.h"
	#include "6502mac.h"
@---------------------------------------------------------------------------------
	.global mapper40init
	countdown = mapperdata+0
	irqen = mapperdata+4
@---------------------------------------------------------------------------------
mapper40init:		@SMB2j
@---------------------------------------------------------------------------------
	.word write0,write1,void,mapCD_

	mov addy,lr
	adr r0,hook
	str_ r0,scanlinehook

	ldr r0,=rom_R60			@Set ROM at $6000-$7FFF.
	str_ r0,readmem_tbl+12
	ldr r0,=empty_W			@ROM.
	str_ r0,writemem_tbl+12

	bl write0

	mov r0,#-1
	bl map89ABCDEF_

	mov r0,#6
	mov lr,addy
	b map67_
@---------------------------------------------------------------------------------
write0:		@$8000-$9FFF
@---------------------------------------------------------------------------------
	mov r0,#36
	str_ r0,countdown
	mov r0,#0
	strb_ r0,irqen
	mov pc,lr
@---------------------------------------------------------------------------------
write1:		@$A000-$BFFF
@---------------------------------------------------------------------------------
	mov r0,#1
	strb_ r0,irqen
	mov pc,lr
@---------------------------------------------------------------------------------
hook:
@---------------------------------------------------------------------------------
	ldrb_ r0,irqen
	cmp r0,#0
	beq hk0

	ldr_ r0,countdown
@	bmi hk0
	subs r0,r0,#1
	str_ r0,countdown
	bcs hk0

	mov r0,#0
	strb_ r0,irqen
@	b irq6502
	b CheckI
hk0:
	fetch 0
@---------------------------------------------------------------------------------
